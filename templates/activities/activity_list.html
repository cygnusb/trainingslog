{% extends "base.html" %}

{% block title %}Activities list{% endblock %}
{% block head %} 

{%  if garmin_keys %}
<style type="text/css" media="all">@import "/media/css/garmin/communicator2.css";</style>
<script type="text/javascript" src="/media/js/garmin/prototype.js"></script>
<script type="text/javascript" src="/media/js/garmin/device/GarminDeviceDisplay.js"></script>
<script type="text/javascript" src="/media/js/garmin/device/GarminDevicePlugin.js"></script>
<script type="text/javascript" src="/media/js/garmin/device/GarminDeviceControl.js"></script>
<script type="text/javascript" src="/media/js/garmin/util/Util-PluginDetect.js"></script>
{%  endif %}


<script type="text/javascript" src="/media/js/common.js"></script>

<script type="text/javascript" src="/media/js/jquery.js"></script>
<script type="text/javascript" src="/media/js/jquery.tablesorter.js"></script>
<script type="text/javascript" src="/media/js/jquery.tablesorter.pager.js"></script>
<script type="text/javascript" src="/media/jquery-ui/ui/jquery.ui.core.js"></script>
<script type="text/javascript" src="/media/jquery-ui/ui/jquery.ui.widget.js"></script>
<script type="text/javascript" src="/media/jquery-ui/ui/jquery.ui.dialog.js"></script>
<script type="text/javascript" src="/media/jquery-ui/ui/jquery.ui.datepicker.js"></script>
<script type="text/javascript" src="/media/js/jquery.ui.timepicker.js"></script>
<script type="text/javascript" src="/media/jquery-ui/ui/jquery.ui.tabs.js"></script>
<script type="text/javascript" src="/media/js/noty/jquery.noty.js"></script>
<script type="text/javascript" src="/media/js/noty/layouts/top.js"></script>
<script type="text/javascript" src="/media/js/noty/themes/default.js"></script>


<link rel='stylesheet' type='text/css' href='/media/jquery-ui/themes/cupertino/jquery.ui.theme.css' />
<link rel="stylesheet" type="text/css" href="/media/jquery-ui/themes/cupertino/jquery.ui.core.css"></link>
<link rel='stylesheet' type='text/css' href='/media/jquery-ui/themes/cupertino/jquery.ui.dialog.css' />
<link rel="stylesheet" type="text/css" href="/media/jquery-ui/themes/cupertino/jquery.ui.tabs.css"></link>
<link rel="stylesheet" type="text/css" href="/media/jquery-ui/themes/cupertino/jquery.ui.datepicker.css"></link>

<link rel='stylesheet' type='text/css' href='/media/css/jquery.ui.timepicker.css'/>

<link rel='stylesheet' type='text/css' href='/media/css/activitypopup.css'/>

<script>
	var garmincontrol;
	var sport_data = Array();
	
	$(document).ready(function() {
		// Initialize tablesorter

		$.getJSON("/activities/get", function(data) {
			// Add the messages div to the container
			//                $("#container").append("<div id='messages'></div>");
			
			//				console.debug($("myTable tbody").html());
			// $("#myTable").show("slow");
			$("#myTable tbody").empty();
			$.each(data, function(i, item) {
				$("#myTable tbody").append('<tr><td><a class="activityPopupTrigger" href="/activities/' + item.id + '/" rel="' + item.id + '">' + item.name 
					+ '</a>&nbsp;&nbsp;&nbsp;<img src="/media/img/edit-icon.png" alt="Bearbeiten" onclick="show_activity_dialog(' + item.id + ')"/>&nbsp;&nbsp;'
					+ '<img src="/media/img/delete-icon.png" alt="L&ouml;schen" onclick="show_activity_delete_dialog(' + item.id + ')"/></td><td>' 
					+ item.sport + '</td><td>'+ item.date + '</td><td>' + item.duration + '</td></tr>');
			});
			$.tablesorter.addParser({
				id: 'datestring',
				is: function(s) {
					return false;
				},
				format: function(s) {
					var date_time = s.split(' ');
					var date = date_time[0].split('.');
					var time = date_time[1].split(':');
					var date = new Date(year = parseInt(date[2]), month = parseInt(date[1]), day = parseInt(date[0]), hours = parseInt(time[0]), minutes = parseInt(time[1]), seconds = 0);
					return date.getTime();
				},
				type: 'numeric'
			});
			$("#myTable").tablesorter({
					headers: {2: { sorter:'datestring' }}
				}).tablesorterPager({
					container: $("#pager"), 
					positionFixed: false
				});
			$("#myTable").trigger("sorton", [[[2,1], [0,0]]]);
			$("#list").remove();
			$('#container').show('slow');


		});

		{%  if garmin_keys %}
		try {
			control = new Garmin.DeviceControl();
			if (control && control.isPluginInitialized()) {

			   	var display = new Garmin.DeviceDisplay("garminDisplay", { 
					pathKeyPairsArray: [{% for url, key in garmin_keys %}"{{url}}", "{{key}}", {% endfor %}],
					showReadDataElement: true,
					showProgressBar: true,
					showFindDevicesElement: true,
					showFindDevicesButton: false,
					showDeviceButtonsOnLoad: false,
					showDeviceButtonsOnFound: false,
					autoFindDevices: true,
					showDeviceSelectOnLoad: true,
					autoHideUnusedElements: true,
					showReadDataTypesSelect: false,
					readDataType: Garmin.DeviceControl.FILE_TYPES.tcxDir,
					deviceSelectLabel: "Choose Device <br/>",
					readDataButtonText:			"List Activities",
					showCancelReadDataButton:		false,
					lookingForDevices: 'Searching for Device <br/><br/> <img src="/media/css/garmin/ajax-loader.gif"/>',
					uploadsFinished: "Transfer Complete",
					uploadSelectedActivities: true,
					uploadCompressedData: false,    // Turn on data compression by setting to true.
					uploadMaximum: 1, 
					dataFound: "#{tracks} activities found on device",
					showReadDataElementOnDeviceFound: true,
					postActivityHandler: function(activityXml, display) {
						console.debug(display);
						data = { filename: "test.tcx", content:activityXml}
						$.post('.', data, function(data) {
							console.debug(data);
							if(data["success"]){
								window.location=data["redirect_to"];
							} else {
								noty({text: "Fehler aufgetreten: " + data["msg"], type: 'error', timeout: 5000});
							}
						}, "json");
					}
		
				});
				$('#garminDisplay').show();


			}
		} catch (e) {
			console.debug("Garmin plugin not installed");
			$('#garminDisplay').hide();			
		}
		
		{%  endif %}	
		$("#activity_add").click(function(){show_activity_dialog();});
		$("#newact_fileform").click(function(){$("#newact_filesubmit").removeAttr("disabled");});
		
	});
	
	// Initialize sport_data array with speed / pace unit information
	{% for sport in sports %}
		{% if sport.speed_as_pace %}
			sport_data[{{sport.id}}] = {'pace': true, 'label': "min/km" };
		{% else %}
			sport_data[{{sport.id}}] = {'pace': false, 'label': "km/h" };
		{% endif %}
	{% endfor %}

	// some tooltip fanciness
	$(function() {
		var hideDelay = 500;
		var hideTimer = null;
		
		var container = $('<div id="activityPopupContainer">'
			+ '<table width="" border="0" cellspacing="0" cellpadding="0" align="center" class="activityPopupPopup">'
			+ '<tr>'
			+ '   <td class="corner topLeft"></td>'
			+ '   <td class="top"></td>'
			+ '   <td class="corner topRight"></td>'
			+ '</tr>'
			+ '<tr>'
			+ '   <td class="left">&nbsp;</td>'
			+ '   <td><div id="activityPopupContent"></div></td>'
			+ '   <td class="right">&nbsp;</td>'
			+ '</tr>'
			+ '<tr>'
			+ '   <td class="corner bottomLeft">&nbsp;</td>'
			+ '   <td class="bottom">&nbsp;</td>'
			+ '   <td class="corner bottomRight"></td>'
			+ '</tr>'
			+ '</table>'
			+ '</div>');
		
		$('body').append(container);
		
		$('.activityPopupTrigger').live('mouseover', function(){
			// format of 'rel' tag: pageid,personguid
			var activity_id = $(this).attr('rel');
		
			if (hideTimer)
				clearTimeout(hideTimer);
		
			var pos = $(this).offset();
			var width = $(this).width();
			container.css({
				left: (pos.left + width) + 'px',
				top: pos.top - 5 + 'px'
			});
		
			$('#activityPopupContent').html('&nbsp;');
		
			$.ajax({
				type: 'GET',
				url: '/activities/get_json',
				data: 'id=' + activity_id,
				success: function(data)
				{
					act = eval(data.activity);
					console.debug(act);
					var fields = act[0].fields;
					console.debug(fields);
	
					var text = "<b>" + fields.name + "</b><table><tr>";
					if(data.hasOwnProperty('preview_img')){
						text = text + '<td><img width=150 src="' + data.preview_img + '" /></td>';
					}
					
					if( fields.distance ){
						var distance = parseFloat(fields.distance).toFixed(2).replace(/\./,",") + " km";
					} else {
						var distance = "-";
					}
					if( fields.time ) {
						var time = secondsToTime(fields.time);
					} else {
						var time = "-";
					}
					if( fields.speed_avg ){
						var speed_avg = parseFloat(fields.speed_avg);
						if(sport_data[fields.sport]["pace"]){
							console.debug("This is with pace");
							speed_avg = speedToPace(speed_avg) + " min/km";
						} else {
							console.debug("This is with speed");
							speed_avg = speed_avg.toFixed(2).replace( /\./,"," ) + " km/h";
						}


					} else {
						var speed_avg = "-"
					}
					console.debug(distance);
					text = text + "<td> " 
						+ "<table><tr><td>Distanz</td><td>" + distance +"</td></tr>" 
						+ "<tr><td>Dauer</td><td>" + time + "</td></tr>"
						+ "<tr><td>Ã˜ Geschwindigkeit</td><td>" + speed_avg + "</td></tr>"
						+ "</table>"
						+ "</td></tr></table>"
					
					console.debug("Text is " + text);
					$('#activityPopupContent').html(text);
				}
			});
		
			container.css('display', 'block');
	
		});
			
	
		$('.activityPopupTrigger').live('mouseout', function(){
			if (hideTimer)
				clearTimeout(hideTimer);
			hideTimer = setTimeout(function(){
				container.css('display', 'none');
			}, hideDelay);
			console.debug("Hide tooltip");
		});
	});
</script>
{% endblock %}
{% block content %}
<p id="list">
	Loading...
</p>
<div id="container"  style="display:none;">
	<table id="myTable" class="tablesorter">
		<thead>
			<tr>
				<th>Name</th>
				<th>Typ</th>
				<th>Datum</th>
				<th>Dauer</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<div id="pager" class="pager">
		<form>
			<img src="/media/img/first.png" class="first"/>
			<img src="/media/img/prev.png" class="prev"/>
			<input type="text" class="pagedisplay"/>
			<img src="/media/img/next.png" class="next"/>
			<img src="/media/img/last.png" class="last"/>
			<select class="pagesize">
				<option selected="selected"  value="10">10</option>

				<option value="3">3</option>
				<option value="20">20</option>
				<option value="30">30</option>
				<option  value="40">40</option>
			</select>
		</form>
	</div>
</div>
<p>
	<input type="submit" id="activity_add" value="Neue Aktivit&auml;t...">
</p>

<!-- Upload form. Note enctype attribute! -->
<form method="post" enctype="multipart/form-data">
    <input id = "newact_fileform" type="file" name="trackfile" />
	<input id = "newact_filesubmit" type="submit" value="Upload" disabled="disabled"/>
</form>

{%  if garmin_keys %}
<table border="0" cellpadding="4" cellspacing="0" width="100%">
	<tr>
		<td>
			<div id="garminDisplay" style="display:none;"></div>
		</td>
	</tr>
	<tr>
		<td>
			<div id="activity"></div>
		</td>
	</tr>
</table>
{%  endif %}

{% include "activities/includes/activity_dialog.html" %}

<div id="alert_dialog" title="Fehler">
	<div id="alert_dialog_content"></div>
</div>
{% endblock %} 
